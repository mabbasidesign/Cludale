trigger:
  - master

pool:
  vmImage: 'ubuntu-latest'

variables:
  location: 'westus'
  rgName: 'rg-cludale'
  acrName: 'acrcludale'
  imageName: 'cludale'
  tag: '$(Build.BuildId)'
  dockerfilePath: 'Dockerfile'
  buildContext: '.'

stages:

# ===============================
# STAGE 1: INFRA (IDEMPOTENT)
# ===============================
- stage: Infra
  displayName: 'Provision Azure Infrastructure'
  jobs:
    - job: InfraJob
      displayName: 'Deploy Bicep'
      steps:
        - task: AzureCLI@2
          displayName: 'Deploy infrastructure using Bicep'
          inputs:
            azureSubscription: 'CludaleAzureSubscription'
            scriptType: 'bash'
            scriptLocation: 'inlineScript'
            inlineScript: |
              az group create \
                --name $(rgName) \
                --location $(location)

              az deployment group create \
                --resource-group $(rgName) \
                --template-file infra/main.bicep \
                --parameters \
                  location=$(location) \
                  imageTag=$(tag) \
                  sqlAdminLogin=$(SQL_ADMIN_LOGIN) \
                  sqlAdminPassword=$(SQL_ADMIN_PASSWORD) \
                  aadAdminLogin=$(AAD_ADMIN_LOGIN) \
                  aadAdminObjectId=$(AAD_ADMIN_OBJECT_ID)
          workingDirectory: $(System.DefaultWorkingDirectory)

# ===============================
# STAGE 2: BUILD
# ===============================
- stage: Build
  dependsOn: Infra
  displayName: 'Build .NET App'
  jobs:
    - job: BuildJob
      steps:
        - task: UseDotNet@2
          inputs:
            packageType: 'sdk'
            version: '8.0.x'

        - script: |
            dotnet restore src/src/ConcertService/ConcertService.csproj
            dotnet build src/src/ConcertService/ConcertService.csproj -c Release
            dotnet publish src/src/ConcertService/ConcertService.csproj -c Release -o publish
          displayName: 'Build .NET App'

# ===============================
# STAGE 3: DOCKER
# ===============================
- stage: Docker
  dependsOn: Build
  displayName: 'Build & Push Docker Image'
  jobs:
    - job: DockerJob
      steps:
        - task: Docker@2
          displayName: 'Build and Push Image to ACR'
          inputs:
            command: buildAndPush
            repository: '$(imageName)'
            dockerfile: '$(dockerfilePath)'
            buildContext: '$(buildContext)'
            tags: |
              $(tag)
              latest
            containerRegistry: 'CludaleAzureSubscription'
