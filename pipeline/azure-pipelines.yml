trigger:
  - master  # Trigger pipeline on master branch

# ===============================
# Use self-hosted agent
# ===============================
pool:
  name: Default  # <-- your self-hosted agent pool
  # remove vmImage entirely

variables:
  location: 'westus'              # Azure region
  rgName: 'rg-cludale'            # Resource Group name
  acrName: 'acrcludale'           # Azure Container Registry name
  imageName: 'cludale'            # Docker image repository name
  tag: '$(Build.BuildId)'         # Docker image tag = Build ID
  dockerfilePath: 'Dockerfile'    # Path to Dockerfile
  buildContext: '.'               # Docker build context
  acaName: 'my-containerapp'      # Azure Container App name
  acaEnv: 'my-aca-env'            # ACA environment name
  databaseName: 'ConcertDb'       # SQL database name

stages:

# ===============================
# STAGE 1: INFRA (IDEMPOTENT)
# ===============================
- stage: Infra
  displayName: 'Provision Azure Infrastructure'
  jobs:
    - job: InfraJob
      displayName: 'Deploy Bicep and capture outputs'
      steps:
        - task: AzureCLI@2
          displayName: 'Create Resource Group'
          inputs:
            azureSubscription: 'CludaleAzureSubscription'
            scriptType: 'ps'
            scriptLocation: 'inlineScript'
            inlineScript: |
              az group create --name $(rgName) --location $(location)

        - task: AzureCLI@2
          displayName: 'Deploy Bicep'
          inputs:
            azureSubscription: 'CludaleAzureSubscription'
            scriptType: 'ps'
            scriptLocation: 'inlineScript'
            inlineScript: |
              az deployment group create \
                --resource-group $(rgName) \
                --name $(Build.BuildId) \
                --template-file infra/main.bicep \
                --parameters \
                  location=$(location) \
                  imageTag=$(tag) \
                  sqlAdminLogin=$(SQL_ADMIN_LOGIN) \
                  sqlAdminPassword=$(SQL_ADMIN_PASSWORD) \
                  aadAdminLogin=$(AAD_ADMIN_LOGIN) \
                  aadAdminObjectId=$(AAD_ADMIN_OBJECT_ID)

        - task: AzureCLI@2
          displayName: 'Capture Bicep Outputs'
          inputs:
            azureSubscription: 'CludaleAzureSubscription'
            scriptType: 'ps'
            scriptLocation: 'inlineScript'
            inlineScript: |
              ACR_LOGIN_SERVER=$(az deployment group show \
                --resource-group $(rgName) \
                --name $(Build.BuildId) \
                --query "properties.outputs.acrLoginServer.value" -o tsv)

              SQL_FQDN=$(az deployment group show \
                --resource-group $(rgName) \
                --name $(Build.BuildId) \
                --query "properties.outputs.sqlFqdn.value" -o tsv)

              echo "##vso[task.setvariable variable=acrLoginServer]$ACR_LOGIN_SERVER"
              echo "##vso[task.setvariable variable=sqlFqdn]$SQL_FQDN"

# ===============================
# STAGE 2: BUILD .NET APP
# ===============================
- stage: Build
  dependsOn: Infra
  displayName: 'Build .NET App'
  jobs:
    - job: BuildJob
      displayName: 'Build .NET App'
      steps:
        - task: UseDotNet@2
          inputs:
            packageType: 'sdk'
            version: '8.0.x'

        - script: |
            dotnet restore src/src/ConcertService/ConcertService.csproj
            dotnet build src/src/ConcertService/ConcertService.csproj -c Release
            dotnet publish src/src/ConcertService/ConcertService.csproj -c Release -o publish
          displayName: 'Build and Publish .NET App'

# ===============================
# STAGE 3: DOCKER IMAGE (Self-hosted)
# ===============================
- stage: Docker
  dependsOn: Build
  displayName: 'Build & Push Docker Image'
  jobs:
    - job: DockerJob
      displayName: 'Docker Build & Push'
      steps:
        - task: AzureCLI@2
          displayName: 'Login to ACR'
          inputs:
            azureSubscription: 'CludaleAzureSubscription'
            scriptType: 'ps'
            scriptLocation: 'inlineScript'
            inlineScript: |
              echo "Logging in to Azure Container Registry..."
              az acr login --name $(acrName)

        - task: Docker@2
          displayName: 'Build & Push Image'
          inputs:
            command: buildAndPush
            repository: '$(imageName)'
            dockerfile: '$(dockerfilePath)'
            buildContext: '$(buildContext)'
            tags: |
              $(tag)
              latest

# ===============================
# STAGE 4: DEPLOY ACA + SQL MI ACCESS
# ===============================
- stage: Deploy
  dependsOn: Docker
  displayName: 'Deploy to Azure Container Apps'
  jobs:
    - job: ACAJob
      displayName: 'Deploy ACA & Grant SQL Access'
      steps:
        - task: AzureCLI@2
          displayName: 'Deploy ACA'
          inputs:
            azureSubscription: 'CludaleAzureSubscription'
            scriptType: 'ps'
            scriptLocation: 'inlineScript'
            inlineScript: |
              az containerapp create \
                --name $(acaName) \
                --resource-group $(rgName) \
                --image $(acrLoginServer)/$(imageName):$(tag) \
                --environment $(acaEnv) \
                --registry-server $(acrLoginServer) \
                --cpu 0.5 --memory 1.0Gi \
                --min-replicas 1 --max-replicas 3 \
                --enable-managed-identity

        - task: AzureCLI@2
          displayName: 'Grant SQL DB Access to ACA MI'
          inputs:
            azureSubscription: 'CludaleAzureSubscription'
            scriptType: 'bash'
            scriptLocation: 'inlineScript'
            inlineScript: |
              ACA_MI_PRINCIPAL=$(az containerapp show \
                --name $(acaName) \
                --resource-group $(rgName) \
                --query identity.principalId -o tsv)

              az extension add --name sql

              az sql db ad-admin create \
                --server $(sqlFqdn) \
                --resource-group $(rgName) \
                --display-name "ACA-MI-Admin" \
                --object-id $ACA_MI_PRINCIPAL \
                --role "db_datareader"
